<!DOCTYPE html>
<html>
    <head>
        <title>Game 3</title>
        <meta charset="UTF-8">
        <link rel="stylesheet" type="text/css" href="style.css">
        <style>
            div.number {
                display:none
            }
            #dot {
                width: 10px;
                height: 10px;
                top: -5px;
                left: -4px;
                border-radius: 6px;
                background: black;
                position: absolute;
            }
            #OK_button {
                height: 40px;
                width: 90px;
                top: 500px;
                left: 445px;
                border-radius: 150px;
                border: 10px solid lawngreen;
                color: white;
                text-align: center;
                justify-content: center;
                align-items: center;
                font-size: 20px;
                display: none;
                opacity: 0.3;
                background: #82B366;
                position: absolute;
            }
            #guide {
                top: 120px;
                left: 100px;
                background: navajowhite;
                text-align: center;
                vertical-align: middle;
                padding-top: 20px;
                padding-bottom: 20px;
                padding-left: 80px;
                padding-right: 80px;
                font-size: 20px;
                border-radius: 20px;
                border: 10px solid green;
                display: none;
                position: absolute;
            }
        </style>
        <script src="resize.js"></script>
    </head>
    <body onload="fixPosition()">
        <div id="container" style="top: 105.333px; left: -425px;">
            <div id="back_button" draggable="false" style="left: 20px; top: 30px; font-size: 20px; position: absolute;">
                <a href="Main.html" draggable="false">< Back</a>
            </div>
            <div id="displayScore">
                <div class="ball" style="left: 10px; top: 10px"></div>
                <div class="ball" style="left: 35px; top: 10px"></div>
                <div class="ball" style="left: 60px; top: 10px"></div>
                <div class="ball " style="left: 85px; top: 10px"></div>
                <div class="ball" style="left: 110px; top: 10px"></div>
                <div class="ball" style="left: 135px; top: 10px"></div>
                <div class="ball" style="left: 160px; top: 10px"></div>
                <div class="ball" style="left: 185px; top: 10px"></div>
                <div class="ball" style="left: 210px; top: 10px"></div>
            </div>
            <div style="width: 1000px; height: 1px; top: 75px; background: lightgrey; position: absolute"></div>
            <div id="guide"></div>
            <div id="game_display" style="top: 300px; opacity: 0.2">
                <div class="number" style="left: 32px; top: 68px; font-size: 23px; font-weight: bold; display: block">0</div>
                <div class="number" style="left: 102px;">1</div>
                <div class="number" style="left: 173px;">2</div>
                <div class="number" style="left: 243px;">3</div>
                <div class="number" style="left: 313px;">4</div>
                <div class="number" style="left: 383px; top: 68px; font-size: 23px; font-weight: bold">5</div>
                <div class="number" style="left: 453px">6</div>
                <div class="number" style="left: 523px">7</div>
                <div class="number" style="left: 593px">8</div>
                <div class="number" style="left: 663px">9</div>
                <div class="number" style="left: 725px; top: 68px; font-size: 23px; font-weight: bold">10</div>
                <div id="line">
                    <div style="left: 708px; top: -14px; position: absolute; font-size: 22px">></div>
                    <div class="point" style="width: 2px"></div>
                    <div class="point" style="left: 70px"></div>
                    <div class="point" style="left: 140px"></div>
                    <div class="point" style="left: 210px"></div>
                    <div class="point" style="left: 280px"></div>
                    <div class="point" style="width: 2px; left: 350px"></div>
                    <div class="point" style="left: 420px"></div>
                    <div class="point" style="left: 490px"></div>
                    <div class="point" style="left: 560px"></div>
                    <div class="point" style="left: 630px"></div>
                    <div class="point" style="width: 2px; left: 700px"></div>
                    <div id="highlight" style="height: 4px; top: -2px; left: 0px; background: greenyellow; display: block; position: absolute"></div>
                    <div id="dot" onmousedown="mousedown(event)" style="left: -4px; cursor: default;">
                        <div style="top: -67px; margin-left: -18px; position: absolute">
                            <img id="grasshopper" src="../Picture/grasshopper1.png" draggable="false" style="margin-top: 0px; margin-left: 0px">
                        </div>
                    </div>
                    <div id="box" class="box" style="border: 5px solid gold; top: 30px; color: red; display: none"></div>
                </div>
            </div>
            <div id="start_button" onclick="start()" onmouseover="over()" onmouseout="out()" style="left: 425px; top: 300px; width: 150px; height: 150px">
                <div id="start_button_1" style="left: 15px; top: 15px; width: 120px; height: 120px; border-radius: 15px; position: absolute;">
                    <img id="start_img" src="../Picture/Start0.png" width="120px" height="120px" style="border-radius: 120px" draggable="false">
                </div>
                <script src="mouse_on_startButton.js"></script>
            </div>
            <div id="home_button">
                <p><a href="Main.html"> Go to Lesson </a></p>
            </div>
            <div id="OK_button" onclick="check_answer()">OK</div>
        </div>
        <script>
            var index = 1;
            var guide = document.getElementById("guide");
            var box = document.getElementById("box");
            var number = document.getElementsByClassName("number");
            var grasshopper = document.getElementById("grasshopper");
            var start_button = document.getElementById("start_button");
            var dot = document.getElementById("dot");
            var OK_button = document.getElementById("OK_button");
            var ball = document.getElementsByClassName("ball");
            var highlight = document.getElementById("highlight");
            var grasshopper_margin = 0;
            var x;
            var score = 0;
            var dot_left = -5;
            var status = 0;
            var canMove = 0;
            var canPress = 0;
            var stage = 0;
            var length = 0;
            var check_correct = 1;
            var question = [4, 2, 5, 8, 3, 9, 6, 1, 7];
            var now_number = 0;
            function start() {
                canMove = 0;
                var count = 0;
                var t = setInterval(show, 20);
                function show() {
                    if (count == 8) {
                        clearInterval(t);
                        start_button.style.display = 'none';
                    }
                    else {
                        count ++;
                        game_display.style.opacity = (count * 0.1) + 0.2;
                        start_button.style.opacity = 1 - (count * 0.1);
                    }
                }
                setTimeout(new_question, 1000);
            }
            function restart() {
                game_display.style.opacity = 0.2;
                if (score == 0 ) {
                    index = 1;
                    var t = setInterval(move_back_0, 1);
                    start_button.style.opacity = 1;
                    start_button.style.display = 'block';
                    for (var i = 1; i < 10; i++) number[i].style.display = 'none';
                }
                else if (score < 9){
                    stage = 1;
                    index = question[0];
                    question.shift();
                    question.push(index);
                    OK_button.style.display = 'block';
                    var t = setInterval(move_back_0, 1);
                    start_button.style.opacity = 1;
                    start_button.style.display = 'block';
                    for (var i = 1; i < 10; i++) number[i].style.display = 'none';
                    number[10].style.display = 'block';
                }
                else {
                    document.getElementById("home_button").style.display = 'block';
                }
                function move_back_0() {
                    if (dot_left == -4) clearInterval(t);
                    else {
                        dot_left -= 5;
                        dot.style.left = dot_left + "px";
                        length -= 5;
                        highlight.style.width = length + "px";
                    }
                }
            }
            function new_question() {
                var count = 0;
                if (stage == 0) {
                    if (index < 6) {
                        var t = setInterval(jump, 5);
                        move_highlight(1);
                    }
                    else if (index < 10) {
                        move_highlight(1);
                        make_question();
                    }
                    else {
                        if (check_correct == 1) {
                            score_increase();
                        setTimeout(restart, 100);
                        }
                        else {
                            setTimeout(function() {
                                game_display.style.display = 'none';
                                dot_left = -4;
                                dot.style.left = "-4px";
                                length = 0;
                                highlight.style.width = "0px";
                                index = 1;
                                for (var i = 1; i < 10; i++) number[i].style.display = 'none';
                            }, 100);
                            setTimeout(function() {game_display.style.display = 'block';}, 300);
                            setTimeout(start, 500);
                        }
                    }
                }
                else if (stage == 1) {
                    give_guide("Move the grasshopper to point " + index);
                    setTimeout(make_question, 100);
                }
                function jump() {
                    if (count >= 70) {
                        clearInterval(t);
                        make_question();
                    }
                    else {
                        count += 1;
                        dot_left += 1;
                        dot.style.left = dot_left + "px";
                        if (count <= 35) grasshopper.style.marginTop = - (count) + "px";
                        else grasshopper.style.marginTop = - (70 - count) + "px";
                    }
                }
            }
            function move_highlight(n) {
                var count = 0;
                var t = setInterval(function() {
                    if (count >= n * 70) {
                        clearInterval(t);
                    }
                    else {
                        length ++;
                        highlight.style.width = length + "px";
                        count ++;
                    }
                }, 5);
            }
            function make_question() {
                if (stage == 0) {
                    if (index < 6) {
                        setTimeout(set_box_block, 500, index);
                        if (index < 3) setTimeout(correct, 1500);
                        else if (index < 6) {
                            setTimeout(set_box_block, 500, index);
                            if (index == 3) setTimeout(function() {give_guide("Write the number");}, 600);
                            setTimeout(canPress = 1, 1000);
                        }
                    }
                    else if (index < 10) {
                        canMove = 1;
                        dot.style.cursor = 'pointer';
                        give_guide("Now you move the grasshopper 1 step forward");
                    }
                    else {
                        restart();
                    }
                }
                else if (stage == 1) {
                    canMove = 1;
                    grasshopper.style.cursor = 'pointer';
                }
                addEventListener('keydown', function(event) {
                    if (canPress == 1 && stage == 0) {
                        if (event.keyCode >= 48 && event.keyCode <= 57) {
                            if (event.keyCode == index + 48) {
                                if (box.style.display == "block") {
                                    correct();
                                    canPress = 0;
                                }
                                setTimeout(function() {guide.style.display = 'none';}, 200);
                            }
                            else {
                                box.innerHTML = event.keyCode - 48;
                                check_correct = 0;
                            }
                        }
                    }
                });
                function correct() {
                    number[index].style.display = 'block';
                    set_box_none();
                    setTimeout(index += 1, 999);
                    setTimeout(new_question, 1000);
                }
            }
            function mousedown(ev) {
                x = ev.x;
                if (canMove == 1) {
                    status = 1;
                    document.getElementById("grasshopper").style.marginTop = "-5px";
                }
                document.addEventListener('mousemove', function (evt) {
                    if (status == 1) {
                        if (now_number == 0) {
                            dot_left = dot_left + event.x - x;
                            x = event.x;
                            if (dot_left < -4) dot.style.left = "-4px";
                            else if (dot_left > 696) dot.style.left = "696px";
                            else dot.style.left = dot_left + "px";
                        }
                        else {
                            grasshopper_margin -= event.x - x;
                            x = event.x;
                            if (grasshopper_margin > dot_left + 4) grasshopper.style.marginLeft = (- (dot + 4)) + 'px';
                            else if (grasshopper_margin < (dot_left + 4 - now_number * 70)) grasshopper.style.marginLeft = (-(dot_left + 4 - now_number*70)) + 'px';
                            else grasshopper.style.marginLeft = (- grasshopper_margin) + "px";
                        }
                    }
                });
            }
            function give_guide(message) {
                guide.innerHTML = message;
                guide.style.display = 'block';
            }
            addEventListener('mouseup', function () {
                if (status == 1) {
                    status = 0;
                    document.getElementById("grasshopper").style.marginTop = '0px';
                    if (now_number == 0) {
                        if (dot_left > 696) {
                            dot_left = 696;
                            if (stage == 1) OK_on();
                        } else if (dot_left < -4) {
                            dot_left = -4;
                            if (stage == 1) OK_off();
                        } else {
                            var tmp = Math.round((dot_left + 4) / 70) * 70 - 4;
                            var change;
                            if (tmp > dot_left) {
                                change = 1;
                            } else change = -1;
                            var t = setInterval(move_to_near, 10);
                            function move_to_near() {
                                if (dot_left == tmp) {
                                    clearInterval(t);
                                    if (stage == 0) check();
                                    else {
                                        if (dot_left == -4) OK_off();
                                        else OK_on();
                                    }
                                } else {
                                    dot_left += change;
                                    dot.style.left = dot_left + "px";
                                }
                            }
                            function check() {
                                if (dot_left + 4 == 70 * index) {
                                    canMove = 0;
                                    dot.style.cursor = "default";
                                    setTimeout(set_box_block, 500, index);
                                    if (stage == 0) setTimeout(function () {
                                        guide.style.display = 'none'
                                    }, 300);
                                    setTimeout(canPress = 1, 1000);
                                }
                            }
                        }
                    }
                    else if (now_number > 0) {
                        if (grasshopper_margin > dot_left + 4) grasshopper_margin = dot_left + 4;
                        else if (grasshopper_margin < (dot_left + 4 - now_number * 70)) {
                            grasshopper_margin = dot_left + 4 - (now_number * 70);
                            console.log(grasshopper_margin);
                            canMove = 0;
                            setTimeout(function() {
                                set_box_block(now_number);
                                canMove = 0;
                                give_guide("Write the number");
                            }, 100);
                            setTimeout(function() {canPress = 1;}, 200);
                        }
                        else {
                            var tmp =  (Math.round(grasshopper_margin / 70)) * 70;
                            var change;
                            if (tmp > grasshopper_margin) change = 1;
                            else change = -1;
                            var t = setInterval(move_to_near, 10);
                            function move_to_near() {
                                if (tmp == grasshopper_margin) {
                                    clearInterval(t);
                                    if (dot_left + 4 == tmp + now_number * 70) {
                                        canMove = 0;
                                        setTimeout(function () {
                                            set_box_block(now_number);
                                        }, 100);
                                        setTimeout(function () {
                                            canPress = 1;
                                            give_guide("Write the number");
                                        }, 200);
                                    }
                                }
                                else {
                                    grasshopper_margin += change;
                                    grasshopper.style.marginLeft = (- grasshopper_margin) + "px";
                                }
                            }
                        }
                    }
                }
            });
            function check_answer() {
                OK_off();
                if (dot_left != -4) {
                    if (dot_left + 4 == index * 70) {
                        canMove = 0;
                        OK_off();
                        number[index].style.display = 'block';
                        setTimeout(move_highlight, 300, index);
                        setTimeout(function() {
                            game_display.style.opacity = 0;
                            guide.style.display = 'none';
                            OK_button.style.opacity = 0;
                            score_increase();
                        }, index * 350 + 1000);
                        setTimeout(restart, index * 350 + 1000);
                    }
                    else try_again();
                }
            }
            function try_again() {
                grasshopper.src = '../Picture/grasshopper2.png';
                dot.style.background = 'red';
                guide.style.display = 'none';
                dot.style.cursor = 'pointer';
                setTimeout(function () {
                    var t = setInterval(function() {
                        if (grasshopper_margin >= (dot_left + 4)) {
                            clearInterval(t);
                            setTimeout(function() {grasshopper.src = '../Picture/grasshopper1.png'}, 100);
                            setTimeout(next_num, 200);
                        }
                        else {
                            grasshopper_margin += 5;
                            grasshopper.style.marginLeft = - grasshopper_margin + "px";
                        }
                    }, 5);
                }, 200);
            }
            function next_num() {
                if (now_number < index) {
                    now_number += 1;
                    move_highlight(1);
                    setTimeout(function () {
                        canMove = 1;
                        give_guide("Move the grasshopper 1 step forward");
                    }, 400);
                }
                else setTimeout(function(){
                    now_number = 0;
                    game_display.style.display = 'none';
                    for (var i = 1; i < 10; i++) number[i].style.display = 'none';
                    OK_button.style.display = 'none';
                    grasshopper_margin = 0;
                    grasshopper.style.marginLeft = "0px";
                    length = 0 ;
                    highlight.style.width = "0px";
                    dot_left = -4;
                    dot.style.left = "-4px";
                    dot.style.background = 'black';
                    setTimeout(function() {
                        game_display.style.display = 'block';
                        OK_button.style.display = 'block';
                        canMove = 1;
                        setTimeout(give_guide, 200, "Move the grasshopper to point " + index);
                    }, 700);
                }, 200);
            }
            addEventListener('keydown', function(event) {
                if (canPress == 1 && stage == 1) {
                    console.log(event.keyCode, now_number);
                    if (event.keyCode >= 48 && event.keyCode <= 57) {
                        if (event.keyCode == now_number + 48) {
                            number[now_number].style.display = 'block';
                            canPress = 0;
                            setTimeout(set_box_none, 100);
                            setTimeout(function () {
                                guide.style.display = 'none';
                            }, 200);
                            setTimeout(next_num, 300);
                        } else box.innerHTML = event.keyCode - 48;
                    }
                }
            });
            function set_box_block(number) {
                box.style.left = number * 70 - 15 + "px";
                box.style.display = 'block';
            }
            function set_box_none() {
                canPress = 0;
                box.innerHTML = " ";
                box.style.display = 'none';
            }
            function OK_on() {
                OK_button.style.opacity = 1;
                OK_button.style.cursor = 'pointer';
            }
            function OK_off() {
                OK_button.style.opacity = 0.3;
                OK_button.style.cursor = 'default';
            }
        </script>
        <script src="change_score.js"></script>
    </body>
</html>